!function(){"use strict";let e=window.location.pathname.split("/"),t=e[e.length-1],n=new URLSearchParams(window.location.search),i=n.get("event"),a=null,r="overview",o=null;async function l(){if(!t||isNaN(t)){console.error("❌ Invalid character ID"),window.location.href="/characters";return}try{a=await fetchAPI(`/characters/${t}`),console.log("✅ Character loaded:",a);let e=a.name||a.full_name||"Unknown";document.title=`${e} - Periaphe`;let n=document.getElementById("page-title");n&&(n.textContent=`${e} - Periaphe`),document.body.dataset.characterId=t,function e(){let t=document.getElementById("hero-image"),n=document.getElementById("hero-name"),i=document.getElementById("hero-quote");if(!t||!n||!i){console.error("❌ Hero elements not found");return}let r=a.profile_image||"/static/images/default-avatar.jpg";if(console.log("\uD83D\uDDBC️ Loading hero image:",r),t.src=r,t.alt=a.name||"Character",t.onerror=function(){if(console.log("⚠️ Hero image failed, trying default"),-1===this.src.indexOf("default-avatar.jpg"))this.src="/static/images/default-avatar.jpg";else{console.log("⚠️ Default image also failed, using gradient"),this.style.display="none";let e=document.querySelector(".hero-image-wrapper");e&&(e.style.background="linear-gradient(135deg, #1a1a1a 0%, #3b82f6 50%, #8b5cf6 100%)",e.style.backgroundSize="200% 200%",e.style.animation="gradientShift 8s ease infinite")}},n.textContent=a.name||a.full_name||"Unknown Character",a.quote&&a.quote.trim()?(i.textContent=a.quote,i.style.display="block"):i.style.display="none","undefined"!=typeof gsap&&gsap.to){let o=function(){gsap.to(".hero-image-wrapper",{yPercent:30,ease:"none",scrollTrigger:{trigger:".hero-section",start:"top top",end:"bottom top",scrub:1}})};t.complete&&0!==t.naturalHeight?o():t.addEventListener("load",o)}console.log("✅ Hero section loaded")}(),function e(){let t=document.getElementById("identity-grid");if(!t)return;let n=a.family&&a.family.name||"Unknown",i=[{label:"Full Name",value:a.full_name},{label:"Alias",value:a.nickname},{label:"Birthday",value:a.birthday?formatDate(a.birthday):null},{label:"Family",value:n}].filter(function(e){return e.value});t.innerHTML=i.map(function(e){return`
                <div class="info-item">
                    <span class="info-label">${e.label}</span>
                    <span class="info-value">${e.value}</span>
                </div>
            `}).join(""),console.log("✅ Identity section loaded")}(),function e(){let t=document.getElementById("bio-sections");if(!t)return;let n=a.bio_sections||[];if(0===n.length){t.innerHTML='<p class="empty-state">No additional information available.</p>';return}n.sort(function(e,t){return e.display_order-t.display_order}),t.innerHTML=n.map(function(e){let t="function"==typeof parseMarkdown?parseMarkdown(e.content):e.content.replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");return`
                <div class="bio-section glass-card fade-in-up" data-section-id="${e.id}">
                    <h2 class="section-title">${e.section_title}</h2>
                    <div class="bio-content" data-raw-content="${encodeURIComponent(e.content)}">
                        ${t}
                    </div>
                </div>
            `}).join(""),console.log("✅ Bio sections loaded")}(),function e(){let t=document.documentElement;if(a.color_primary){t.style.setProperty("--accent",a.color_primary);let n=a.color_primary.replace("#",""),i=parseInt(n.substr(0,2),16),r=parseInt(n.substr(2,2),16),o=parseInt(n.substr(4,2),16);t.style.setProperty("--accent-rgb",`${i}, ${r}, ${o}`),console.log("\uD83C\uDFA8 Character theme applied:",a.color_primary)}a.theme_data&&function e(t){if(t){if(t.cursor&&(document.body.style.cursor=`url('${t.cursor}'), auto`),t.background_pattern&&(document.body.style.backgroundImage=`url('${t.background_pattern}')`),t.custom_css){let n=document.createElement("style");n.textContent=t.custom_css,document.head.appendChild(n)}console.log("✅ Advanced theme applied")}}(a.theme_data)}()}catch(i){console.error("❌ Error loading character:",i),showNotification("Failed to load character","error"),setTimeout(function(){window.location.href="/characters"},2e3)}}function s(e){console.log("\uD83D\uDD04 Switching to tab:",e),r=e,document.querySelectorAll(".nav-item").forEach(function(t){t.dataset.tab===e?t.classList.add("active"):t.classList.remove("active")}),document.querySelectorAll(".tab-panel").forEach(function(e){e.classList.remove("active")});let t=document.getElementById(`${e}-tab`);if(t&&(t.classList.add("active"),t.dataset.loaded||(c(e),t.dataset.loaded="true")),o&&o.scrollTo)o.scrollTo(".content-area",{offset:-100,duration:.8});else{let n=document.querySelector(".content-area");n&&n.scrollIntoView({behavior:"smooth",block:"start"})}}async function c(e){try{switch(e){case"timeline":await d();break;case"relationships":await u();break;case"love-interests":await f();break;case"gallery":await p()}}catch(t){console.error(`❌ Error loading ${e}:`,t),showNotification(`Failed to load ${e}`,"error")}}async function d(){let e=document.getElementById("timeline-container");if(e)try{let n=await fetchAPI(`/characters/${t}/timeline`);if(!n||0===n.length){e.innerHTML='<p class="empty-state">No timeline events yet.</p>';return}n.sort(function(e,t){return new Date(t.event_date)-new Date(e.event_date)}),e.innerHTML=n.map(function(e){let t=e.era_display||("function"==typeof y?y(e.era):e.era);return`
                    <div class="timeline-item" data-event-id="${e.id}">
                        <div class="timeline-card">
                            <div class="timeline-header-card">
                                <span class="era-badge" data-era="${e.era}">${t}</span>
                                <time class="timeline-date">${formatDate(e.event_date)}</time>
                            </div>
                            <h3 class="timeline-title">${e.title}</h3>
                            <p class="timeline-summary">${e.summary||""}</p>
                        </div>
                    </div>
                `}).join(""),document.querySelectorAll(".timeline-card").forEach(function(e){e.addEventListener("click",function(){let e=this.closest(".timeline-item").dataset.eventId;m(e)})}),"undefined"!=typeof gsap&&gsap.utils&&gsap.utils.toArray(".timeline-item").forEach(function(e,t){gsap.to(e,{opacity:1,x:0,duration:.8,delay:.1*t,scrollTrigger:{trigger:e,start:"top 85%",toggleClass:"visible"}})}),i&&setTimeout(function(){let e=document.querySelector(`[data-event-id="${i}"]`);e&&(o?o.scrollTo(e,{offset:-150,duration:1.2}):e.scrollIntoView({behavior:"smooth",block:"center"}),e.style.animation="highlight 2s ease")},500),console.log("✅ Timeline loaded")}catch(a){throw e.innerHTML='<p class="error-state">Failed to load timeline.</p>',a}}async function u(){let e=document.getElementById("relationships-grid");if(e)try{let n=await fetchAPI(`/characters/${t}/relationships`);if(!n||0===n.length){e.innerHTML='<p class="empty-state">No relationships defined yet.</p>';return}e.innerHTML=n.map(function(e){return`
                    <div class="relationship-card" 
                         data-type="${e.type||""}"
                         onclick="window.location.href='/profile/${e.related_character_id}'">
                        <img src="${e.related_character_image||"/static/images/default-avatar.jpg"}" 
                             alt="${e.related_character_name}"
                             class="relationship-avatar"
                             onerror="this.src='/static/images/default-avatar.jpg'">
                        <div class="relationship-info">
                            <div class="relationship-name">${e.related_character_name||"Unknown"}</div>
                            <div class="relationship-status">${e.status||""}</div>
                        </div>
                    </div>
                `}).join(""),console.log("✅ Relationships loaded")}catch(i){throw e.innerHTML='<p class="error-state">Failed to load relationships.</p>',i}}async function f(){let e=document.getElementById("love-interests-content");if(e)try{let n=await fetchAPI(`/characters/${t}/love-interests`);if(!n||0===n.length){e.innerHTML='<p class="empty-state">No love interests defined yet.</p>';return}let i=n.reduce(function(e,t){return e[t.category]||(e[t.category]=[]),e[t.category].push(t),e},{}),a={canon:"Canon Darlings",once_dated:"Once Dated",implied:"Implied Fondness",unrequited:"Unrequited Crush",au_lovers:"Lovers In Another Life",au_exes:"Exes In Another Life"},r="";["canon","once_dated","implied","unrequited","au_lovers","au_exes"].forEach(function(e){i[e]&&(r+=`
                        <div class="love-category glass-card fade-in-up">
                            <h2 class="section-title">${a[e]}</h2>
                            <div class="love-grid">
                                ${i[e].map(function(e){return`
                                        <div class="love-card">
                                            <img src="${e.partner.profile_image||"/static/images/default-avatar.jpg"}" 
                                                 alt="${e.partner.name}"
                                                 class="love-avatar"
                                                 onerror="this.src='/static/images/default-avatar.jpg'">
                                            <div class="love-info">
                                                <a href="/profile/${e.partner.id}" class="love-name">${e.partner.name}</a>
                                                ${e.description?`<p class="love-description">${e.description}</p>`:""}
                                            </div>
                                        </div>
                                    `}).join("")}
                            </div>
                        </div>
                    `)}),e.innerHTML=r,console.log("✅ Love interests loaded")}catch(o){throw e.innerHTML='<p class="error-state">Failed to load love interests.</p>',o}}async function p(){let e=document.getElementById("gallery-grid");e&&("function"==typeof initGallery?(initGallery(t),console.log("✅ Gallery initialized")):(e.innerHTML='<p class="empty-state">Gallery functionality not available.</p>',console.warn("⚠️ Gallery function not found")))}async function m(e){try{let t=await fetchAPI(`/events/${e}`),n=document.getElementById("event-modal");if(!n)return;let i=t.era_display||("function"==typeof y?y(t.era):t.era);n.querySelector("#modal-era").textContent=i,n.querySelector("#modal-era").dataset.era=t.era,n.querySelector("#modal-title").textContent=t.title,n.querySelector("#modal-date").textContent=formatDate(t.event_date);let a=n.querySelector("#modal-images");a.innerHTML=t.images&&t.images.length>0?t.images.map(function(e){return`<img src="${e}" alt="${t.title}" loading="lazy" onerror="this.style.display='none'">`}).join(""):"";let r=n.querySelector("#modal-description");r.innerHTML=t.full_description||`<p>${t.summary||""}</p>`,n.classList.add("active")}catch(o){console.error("❌ Error loading event:",o),showNotification("Failed to load event details","error")}}async function g(e){return await fetchAPI("/admin/pending-edits",{method:"POST",body:e})}function y(e){return({"pre-52":"Classic","new-52":"New 52",rebirth:"Rebirth","infinite-frontier":"Infinite Frontier",elseworlds:"Elseworlds","post-crisis":"Post-Crisis","future-state":"Future State"})[e]||e}function v(){if("IntersectionObserver"in window){let e=new IntersectionObserver(function(e,t){e.forEach(function(e){if(e.isIntersecting){let n=e.target;n.src=n.dataset.src,n.classList.remove("lazy"),t.unobserve(n)}})});document.querySelectorAll("img.lazy").forEach(function(t){e.observe(t)}),console.log("✅ Lazy loading setup complete")}}document.addEventListener("DOMContentLoaded",async function(){if(console.log("\uD83D\uDE80 Profile page initializing..."),function e(){let t=document.createElement("div");t.id="page-loader",t.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        `,t.innerHTML='<div class="spinner"></div>',document.body.appendChild(t)}(),function e(){if("undefined"==typeof Lenis){console.warn("⚠️ Lenis not loaded, skipping smooth scroll");return}function t(e){o.raf(e),requestAnimationFrame(t)}o=new Lenis({duration:1.2,easing:function(e){return Math.min(1,1.001-Math.pow(2,-10*e))},orientation:"vertical",gestureOrientation:"vertical",smoothWheel:!0,wheelMultiplier:1,smoothTouch:!1,touchMultiplier:2,infinite:!1}),requestAnimationFrame(t),"undefined"!=typeof gsap&&gsap.registerPlugin&&(gsap.registerPlugin(ScrollTrigger),o.on("scroll",ScrollTrigger.update),gsap.ticker.add(function(e){o.raf(1e3*e)}),gsap.ticker.lagSmoothing(0)),console.log("✅ Smooth scroll initialized")}(),function e(){if("undefined"==typeof THREE){console.warn("⚠️ THREE.js not loaded, skipping 3D background");return}let t=document.getElementById("bg-canvas");if(t)try{let n=new THREE.Scene,i=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),a=new THREE.WebGLRenderer({canvas:t,alpha:!0,antialias:!0});a.setSize(window.innerWidth,window.innerHeight),a.setPixelRatio(Math.min(window.devicePixelRatio,2)),i.position.z=5;let r=new THREE.BufferGeometry,o=new Float32Array(7500);for(let l=0;l<7500;l++)o[l]=(Math.random()-.5)*18;r.setAttribute("position",new THREE.BufferAttribute(o,3));let s=new THREE.PointsMaterial({size:.025,color:3900150,transparent:!0,opacity:.7,blending:THREE.AdditiveBlending}),c=new THREE.Points(r,s);n.add(c);let d=[],u=[new THREE.IcosahedronGeometry(1,0),new THREE.OctahedronGeometry(.8,0),new THREE.TetrahedronGeometry(.6,0)];u.forEach(function(e,t){let i=new THREE.MeshBasicMaterial({color:3900150,wireframe:!0,transparent:!0,opacity:.08+.02*t}),a=new THREE.Mesh(e,i);a.position.set((t-1)*2,0,-t),d.push(a),n.add(a)});let f=0,p=0,m=0,g=0;document.addEventListener("mousemove",function(e){m=e.clientX/window.innerWidth*2-1,g=-(2*(e.clientY/window.innerHeight))+1}),function e(){requestAnimationFrame(e),f+=(m-f)*.05,p+=(g-p)*.05,c.rotation.y+=3e-4,c.rotation.x+=2e-4,d.forEach(function(e,t){e.rotation.x+=.001*(t+1),e.rotation.y+=.002*(t+1),e.position.y=.3*Math.sin(5e-4*Date.now()+t)}),i.position.x+=(.8*f-i.position.x)*.05,i.position.y+=(.8*p-i.position.y)*.05,a.render(n,i)}(),t.classList.add("loaded"),window.addEventListener("resize",function(){i.aspect=window.innerWidth/window.innerHeight,i.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight)}),console.log("✅ 3D background initialized")}catch(y){console.error("❌ Error initializing 3D background:",y)}}(),await l(),function e(){let t=document.querySelectorAll(".nav-item");t.forEach(function(e){e.addEventListener("click",function(){let e=this.dataset.tab;s(e)})}),console.log("✅ Navigation setup complete")}(),document.querySelectorAll(".modal-backdrop").forEach(function(e){e.addEventListener("click",function(){this.closest(".modal").classList.remove("active")})}),document.querySelectorAll(".modal-close").forEach(function(e){e.addEventListener("click",function(){this.closest(".modal").classList.remove("active")})}),document.addEventListener("keydown",function(e){"Escape"===e.key&&document.querySelectorAll(".modal.active").forEach(function(e){e.classList.remove("active")})}),console.log("✅ Modals setup complete"),document.body.addEventListener("mouseover",function(e){let n=e.target.closest(".info-item"),i=e.target.closest(".bio-section"),a=null;n?a=n:i&&!i.querySelector("#bio-identity")&&(a=i),a&&!a.querySelector(".edit-btn")&&function e(n){let i=document.createElement("button");i.className="edit-btn",i.innerHTML="✏️",i.title="Suggest an Edit",i.onclick=function(e){e.stopPropagation(),function e(n){if(n.classList.contains("info-item"))(function e(n){let i=n.querySelector(".info-value"),a=i.textContent,r=n.querySelector(".info-label").textContent,o=document.createElement("input");o.type="text",o.value=a,o.className="inline-edit-input",o.style.cssText=`
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--accent);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        `,i.innerHTML="",i.appendChild(o),o.focus(),o.select();let l=async function(){let e=o.value;if(e!==a&&""!==e.trim())try{await g({type:"character",record_id:t,field:r.toLowerCase().replace(/\s+/g,"_"),old_value:a,new_value:e}),showNotification("Edit submitted for approval!","success")}catch(n){showNotification("Failed to submit edit","error")}i.textContent=a};o.addEventListener("blur",l),o.addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),o.blur()),"Escape"===e.key&&(e.preventDefault(),o.removeEventListener("blur",l),i.textContent=a)})})(n);else if(n.classList.contains("bio-section")){let i=n.dataset.sectionId;(function e(t,n){let i=document.getElementById("bio-edit-modal"),a=document.getElementById("bio-edit-form");if(!i||!a)return;let r=t.querySelector(".section-title").textContent,o=t.querySelector(".bio-content"),l=o.dataset.rawContent?decodeURIComponent(o.dataset.rawContent):"";a.elements.section_id.value=n,a.elements.old_value_title.value=r,a.elements.old_value_content.value=l,a.elements.new_value_title.value=r,a.elements.new_value_content.value=l;let s=async function(e){e.preventDefault();let t=a.elements.new_value_title.value,o=a.elements.new_value_content.value,s=0;if(t.trim()&&t!==r)try{await g({type:"character_bio",record_id:n,field:"section_title",old_value:r,new_value:t}),s++}catch(c){showNotification("Failed to submit title edit","error")}if(o.trim()&&o!==l)try{await g({type:"character_bio",record_id:n,field:"content",old_value:l,new_value:o}),s++}catch(d){showNotification("Failed to submit content edit","error")}s>0?showNotification("Edit(s) submitted for approval!","success"):showNotification("No changes were made.","info"),i.classList.remove("active")};a.onsubmit=s,i.classList.add("active")})(n,i)}}(n)},n.style.position="relative",n.appendChild(i),n.addEventListener("mouseleave",function(e){n.contains(e.relatedTarget)||i.remove()},{once:!0})}(a)}),console.log("✅ Contribution buttons setup complete"),function e(){let t=document.getElementById("era-tooltip");if(!t)return;let n={"pre-52":"Classic: The original DC timeline before the 2011 reboot","new-52":"New 52: DC Comics reboot starting in 2011",rebirth:"Rebirth: Restoration of legacy and hope starting in 2016","infinite-frontier":"Infinite Frontier: Omniverse storytelling post-2021",elseworlds:"Elseworlds: Non-canon alternate reality stories","post-crisis":"Post-Crisis: Following Crisis on Infinite Earths (1985-2011)","future-state":"Future State: Dystopian future timeline"};function i(e){t.style.left=e.pageX+15+"px",t.style.top=e.pageY+15+"px"}document.addEventListener("mouseover",function(e){let a=e.target.closest(".era-badge");if(a){let r=a.dataset.era;r&&n[r]&&(t.textContent=n[r],t.classList.add("active"),i(e))}}),document.addEventListener("mousemove",function(e){t.classList.contains("active")&&i(e)}),document.addEventListener("mouseout",function(e){let n=e.target.closest(".era-badge");n&&t.classList.remove("active")}),console.log("✅ Era tooltips setup complete")}(),function e(){let t=document.querySelector(".scroll-indicator");t&&(t.addEventListener("click",function(){let e=document.querySelector(".profile-grid");e&&o?o.scrollTo(e,{offset:-50,duration:1.2}):e&&e.scrollIntoView({behavior:"smooth",block:"start"})}),window.addEventListener("scroll",function(){window.scrollY>200?(t.style.opacity="0",t.style.pointerEvents="none"):(t.style.opacity="1",t.style.pointerEvents="auto")}))}(),setTimeout(function(){(function e(){if("undefined"==typeof gsap||!gsap.utils){console.log("⚠️ GSAP not available, skipping scroll animations");return}gsap.utils.toArray(".glass-card").forEach(function(e,t){gsap.from(e,{opacity:0,y:60,duration:1,delay:.1*t,scrollTrigger:{trigger:e,start:"top 85%",toggleActions:"play none none reverse"}})}),gsap.utils.toArray(".fade-in-up").forEach(function(e,t){gsap.to(e,{opacity:1,y:0,duration:.8,delay:.1*t,scrollTrigger:{trigger:e,start:"top 90%",toggleClass:"visible"}})}),gsap.utils.toArray(".info-item").forEach(function(e,t){gsap.from(e,{opacity:0,y:30,duration:.6,delay:.1*t,scrollTrigger:{trigger:e,start:"top 85%"}})}),console.log("✅ Scroll animations setup complete")})(),function e(){let t=document.getElementById("page-loader");t&&(t.style.opacity="0",setTimeout(function(){t.remove()},500))}()},800),localStorage.getItem("admin_token")){let e=document.getElementById("admin-edit-btn");e&&(e.style.display="flex",e.onclick=function(){window.location.href=`/admin?edit=character&id=${t}`})}console.log("✅ Profile page initialized")}),window.openEventModal=m,window.getEraName=y,document.addEventListener("keydown",function(e){if(e.key>="1"&&e.key<="5"&&!e.ctrlKey&&!e.metaKey){let t=document.activeElement;if("INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName){let n=["overview","timeline","relationships","love-interests","gallery"],i=parseInt(e.key)-1;n[i]&&(s(n[i]),e.preventDefault())}}(e.ctrlKey||e.metaKey)&&"k"===e.key&&e.preventDefault()}),window.performance&&window.performance.mark&&window.addEventListener("load",function(){performance.mark("page-loaded"),setTimeout(function(){let e=performance.getEntriesByType("navigation")[0];e&&(console.log("⏱️ Performance Metrics:"),console.log("  - DOM Content Loaded:",Math.round(e.domContentLoadedEventEnd-e.domContentLoadedEventStart),"ms"),console.log("  - Load Complete:",Math.round(e.loadEventEnd-e.loadEventStart),"ms"),console.log("  - Total Load Time:",Math.round(e.loadEventEnd-e.fetchStart),"ms"))},0)}),window.addEventListener("error",function(e){console.error("❌ Global error:",e.error)}),window.addEventListener("unhandledrejection",function(e){console.error("❌ Unhandled promise rejection:",e.reason)});let h=document.createElement("style");h.textContent=`
        @keyframes highlight {
            0%, 100% { box-shadow: var(--shadow-lg); transform: scale(1); }
            25% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); transform: scale(1.02); }
            50% { box-shadow: 0 0 60px rgba(59, 130, 246, 1); transform: scale(1.03); }
            75% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); transform: scale(1.02); }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
    `,document.head.appendChild(h),window.profileDebug={character:function(){return a},switchTab:s,reload:l,lenis:function(){return o}},console.log("\uD83C\uDF89 Profile modern JavaScript loaded successfully!"),console.log("\uD83D\uDCA1 Use window.profileDebug for debugging utilities")}();
